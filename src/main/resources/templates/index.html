<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facemash</title>
    <style>
        :root {
            --bg-main: #050712;
            --bg-card: rgba(10, 12, 25, 0.96);
            --accent: #ff007a;
            --accent-soft: rgba(255, 0, 122, 0.2);
            --accent-2: #00e0ff;
            --text-main: #f5f5f5;
            --text-muted: #8b8fa3;
            --border-radius-lg: 18px;
            --shadow-soft: 0 24px 60px rgba(0, 0, 0, 0.65);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: radial-gradient(circle at top, #1a1f3a 0, #050712 55%, #020308 100%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-wrap {
            width: 100%;
            max-width: 1220px;
            padding: 24px 20px 40px;
        }

        /* ---------- HEADER ---------- */

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 32px;
        }

        .logo-block {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-circle {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #ffecf7 0, #ff4b9a 40%, #5d1cff 100%);
            box-shadow:
                0 0 0 2px rgba(255, 255, 255, 0.04),
                0 18px 40px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }

        .logo-circle::after {
            content: "";
            position: absolute;
            inset: 8px;
            border-radius: inherit;
            border: 2px solid rgba(255, 255, 255, 0.28);
            mix-blend-mode: screen;
        }

        .logo-text-main {
            font-size: 24px;
            letter-spacing: 0.06em;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .logo-text-main span:first-child {
            color: #ffffff;
        }

        .logo-text-main span:last-child {
            color: var(--accent);
        }

        .logo-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .top-meta {
            text-align: right;
            font-size: 12px;
            color: var(--text-muted);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(10, 12, 25, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.02);
            margin-bottom: 6px;
        }

        .pill-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #28ff8f;
            box-shadow: 0 0 10px rgba(40, 255, 143, 0.9);
        }

        .counter {
            font-size: 12px;
            margin-top: 4px;
        }

        .counter strong {
            color: var(--accent-2);
        }

        /* ---------- TITLE ---------- */

        .title-block {
            text-align: center;
            margin-bottom: 24px;
        }

        .title-block h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .title-block h1 span {
            background: linear-gradient(90deg, #ff4b9a, #ffcf4b, #00e0ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .title-block p {
            margin: 10px 0 0;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* ---------- LAYOUT: MAIN + SIDEBAR ---------- */

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1fr);
            gap: 20px;
            align-items: flex-start;
        }

        /* ---------- MAIN BLOCK (DUEL) ---------- */

        .main-block {
            position: relative;
            background: radial-gradient(circle at top, rgba(255, 0, 122, 0.14), transparent 55%);
            border-radius: 28px;
            padding: 28px 20px 24px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .main-block::before {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            border: 1px solid rgba(255, 255, 255, 0.06);
            opacity: 0.4;
            pointer-events: none;
        }

        .main-inner {
            position: relative;
            z-index: 1;
        }

        .vs-label {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 72px;
            height: 72px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #ffe6f2 0, #ff007a 45%, #5d1cff 110%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            letter-spacing: 0.08em;
            font-size: 16px;
            color: #ffffff;
            box-shadow:
                0 0 0 6px rgba(255, 0, 122, 0.16),
                0 22px 48px rgba(0, 0, 0, 0.9);
        }

        .vs-label::after {
            content: "";
            position: absolute;
            inset: 10px;
            border-radius: inherit;
            border: 2px solid rgba(255, 255, 255, 0.5);
            opacity: 0.8;
        }

        .container {
            display: flex;
            justify-content: center;
            gap: 32px;
            flex-wrap: wrap;
        }

        /* ---------- PERSON CARD ---------- */

        .person {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            padding: 16px 16px 18px;
            width: 280px;
            margin-bottom: 10px;
            position: relative;
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.03),
                0 20px 40px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            overflow: hidden;
            transform: translateY(0) scale(1);
            transition:
                transform 0.18s ease-out,
                box-shadow 0.18s ease-out,
                border 0.18s ease-out,
                opacity 0.18s ease-out;
            opacity: 1;
        }

        .person::before {
            content: "";
            position: absolute;
            inset: -40%;
            background:
                radial-gradient(circle at 10% 0, rgba(255, 0, 122, 0.26), transparent 55%),
                radial-gradient(circle at 110% 110%, rgba(0, 224, 255, 0.14), transparent 55%);
            mix-blend-mode: soft-light;
            opacity: 0.7;
            pointer-events: none;
        }

        .person-inner {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .person:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.08),
                0 26px 64px rgba(0, 0, 0, 0.98);
        }

        .person img {
            width: 100%;
            aspect-ratio: 4 / 5;
            border-radius: 14px;
            margin-bottom: 12px;
            object-fit: cover;
            display: block;
            background: radial-gradient(circle at 30% 20%, #2b3048 0, #090b18 60%, #050712 100%);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
        }

        .name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: 0.02em;
        }

        .elo {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 14px;
        }

        .elo span {
            color: var(--accent-2);
            font-weight: 600;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .meta-pill {
            padding: 3px 10px;
            border-radius: 999px;
            background: rgba(5, 9, 24, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        button {
            background: linear-gradient(120deg, #ff007a, #ff4b9a);
            color: white;
            border: none;
            border-radius: 999px;
            padding: 10px 18px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition:
                background 0.15s ease-out,
                transform 0.1s ease-out,
                box-shadow 0.15s ease-out,
                opacity 0.15s ease-out;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            width: 100%;
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.06),
                0 12px 26px rgba(255, 0, 122, 0.5);
        }

        button:hover {
            background: linear-gradient(120deg, #ff1c8b, #ff6fae);
            transform: translateY(-1px);
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 16px 34px rgba(255, 0, 122, 0.7);
        }

        button:active {
            transform: translateY(1px) scale(0.99);
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.12),
                0 8px 16px rgba(255, 0, 122, 0.5);
        }

        /* ---------- SIDEBAR: TOP LIST ---------- */

        .sidebar {
            background: rgba(5, 7, 18, 0.96);
            border-radius: 22px;
            padding: 18px 16px 16px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.85);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .sidebar-title span {
            color: var(--accent);
        }

        .sidebar-refresh {
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .sidebar-refresh:hover {
            color: #ffffff;
        }

        .top-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 6px;
        }

        .top-table thead {
            color: var(--text-muted);
        }

        .top-table th,
        .top-table td {
            padding: 6px 4px;
            text-align: left;
        }

        .top-table th:nth-child(1),
        .top-table td:nth-child(1) {
            width: 32px;
        }

        .top-table th:nth-child(3),
        .top-table td:nth-child(3) {
            text-align: right;
            width: 70px;
        }

        .top-row td {
            border-top: 1px solid rgba(255, 255, 255, 0.03);
        }

        .badge-rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(10, 12, 25, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .badge-rank.top1 {
            background: radial-gradient(circle at 25% 10%, #fff1c6 0, #ffcf4b 40%, #f99400 100%);
            color: #000;
        }

        .badge-rank.top2 {
            background: radial-gradient(circle at 25% 10%, #f0f4ff 0, #d6e2ff 40%, #8b9ccf 100%);
        }

        .badge-rank.top3 {
            background: radial-gradient(circle at 25% 10%, #ffe2cf 0, #ffb07a 40%, #f37335 100%);
        }

        .sidebar-footer {
            margin-top: 10px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ---------- FOOTER NOTE ---------- */

        .footer-note {
            margin-top: 18px;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
        }

        .footer-note span {
            color: var(--accent);
        }

        /* ---------- ANIMATIONS ---------- */

        .fade-out {
            opacity: 0;
            transform: translateY(8px) scale(0.99);
        }

        .fade-in {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .top-refresh-spin {
            animation: spin 0.6s linear;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ---------- MOBILE ---------- */

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: minmax(0, 1fr);
            }

            .sidebar {
                order: 2;
            }
        }

        @media (max-width: 768px) {
            .page-wrap {
                padding: 16px 14px 28px;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .top-meta {
                text-align: left;
            }

            .title-block h1 {
                font-size: 24px;
            }

            .title-block p {
                font-size: 13px;
            }

            .main-block {
                padding: 22px 14px 18px;
                border-radius: 22px;
            }

            .container {
                flex-direction: column;
                align-items: center;
                gap: 18px;
            }

            .person {
                width: 100%;
                max-width: 410px;
            }

            .vs-label {
                width: 60px;
                height: 60px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
<div class="page-wrap">
    <header class="top-bar">
        <div class="logo-block">
            <div class="logo-circle"></div>
            <div>
                <div class="logo-text-main">
                    <span>FACE</span><span>MASH</span>
                </div>
                <div class="logo-sub">Поставь мир на паузу и выбери, кто горячее.</div>
            </div>
        </div>
        <div class="top-meta">
            <div class="pill">
                <div class="pill-dot"></div>
                live рейтинг · ELO
            </div>
            <div class="counter">
                Твои выборы: <strong id="voteCount">0</strong>
            </div>
        </div>
    </header>

    <section class="title-block">
        <h1><span>Кто привлекательнее?</span></h1>
        <p>Кликаешь по тому, кто выглядит лучше. Алгоритм ELO сам расставит всех по местам в реальном времени.</p>
    </section>

    <div class="layout">
        <!-- MAIN DUEL -->
        <main class="main-block">
            <div class="vs-label">VS</div>
            <div class="main-inner">
                <div class="container">
                    <div class="person" id="p1">
                        <div class="person-inner">
                            <img src="" alt="">
                            <div class="meta-row">
                                <div class="meta-pill">Кандидат A</div>
                                <div>1 клик = 1 дуэль</div>
                            </div>
                            <div class="name"></div>
                            <div class="elo">Рейтинг: <span>—</span></div>
                            <button>Выбрать этого</button>
                        </div>
                    </div>
                    <div class="person" id="p2">
                        <div class="person-inner">
                            <img src="" alt="">
                            <div class="meta-row">
                                <div class="meta-pill">Кандидат B</div>
                                <div>анонимный выбор</div>
                            </div>
                            <div class="name"></div>
                            <div class="elo">Рейтинг: <span>—</span></div>
                            <button>Выбрать этого</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- SIDEBAR TOP LIST -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ТОП <span>по рейтингу</span></div>
                <div class="sidebar-refresh" id="refreshTop">
                    <span id="refreshIcon">⟳</span> обновить
                </div>
            </div>
            <table class="top-table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Имя</th>
                    <th>ELO</th>
                </tr>
                </thead>
                <tbody id="topBody">
                <tr><td colspan="3" style="padding-top: 10px; color: var(--text-muted);">Загрузка рейтинга…</td></tr>
                </tbody>
            </table>
            <div class="sidebar-footer">
                Рейтинг обновляется после каждого голоса. Чем больше побед подряд — тем сильнее прирост.
            </div>
        </aside>
    </div>

    <div class="footer-note">
        Нажми на того, кто <span>выигрывает</span> эту дуэль. Следующая пара загрузится автоматически.
    </div>
</div>

<script>
    let currentPair = [];
    let voteCount = 0;
    const voteCountEl = document.getElementById('voteCount');
    const p1Card = document.getElementById('p1');
    const p2Card = document.getElementById('p2');
    const topBody = document.getElementById('topBody');
    const refreshTopBtn = document.getElementById('refreshTop');
    const refreshIcon = document.getElementById('refreshIcon');

    async function loadPair(withAnimation = false) {
        if (withAnimation) {
            p1Card.classList.add('fade-out');
            p2Card.classList.add('fade-out');
        }

        try {
            const res = await fetch('/pair');
            const pair = await res.json();
            currentPair = pair;

            const applyData = () => {
                // PERSON 1
                document.querySelector('#p1 img').src = pair[0].base64Photo;
                document.querySelector('#p1 img').alt = pair[0].name;
                document.querySelector('#p1 .name').textContent = pair[0].name;
                document.querySelector('#p1 .elo span').textContent = pair[0].elo;
                document.querySelector('#p1 button').onclick = () => vote(pair[0].id, pair[1].id);

                // PERSON 2
                document.querySelector('#p2 img').src = pair[1].base64Photo;
                document.querySelector('#p2 img').alt = pair[1].name;
                document.querySelector('#p2 .name').textContent = pair[1].name;
                document.querySelector('#p2 .elo span').textContent = pair[1].elo;
                document.querySelector('#p2 button').onclick = () => vote(pair[1].id, pair[0].id);
            };

            if (withAnimation) {
                setTimeout(() => {
                    applyData();
                    p1Card.classList.remove('fade-out');
                    p2Card.classList.remove('fade-out');
                    // триггер рефлоу
                    void p1Card.offsetWidth;
                    p1Card.classList.add('fade-in');
                    p2Card.classList.add('fade-in');
                    setTimeout(() => {
                        p1Card.classList.remove('fade-in');
                        p2Card.classList.remove('fade-in');
                    }, 180);
                }, 180);
            } else {
                applyData();
            }
        } catch (e) {
            console.error('Ошибка загрузки пары', e);
        }
    }

    function vote(winnerId, loserId) {
        const formData = new URLSearchParams();
        formData.append('winnerId', winnerId);
        formData.append('loserId', loserId);

        fetch('/NewElo', {
            method: 'POST',
            body: formData,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        }).catch(e => console.error('Ошибка голосования', e));

        voteCount++;
        voteCountEl.textContent = voteCount.toString();

        loadPair(true);
        loadTop(); // обновляем топ после голоса
    }

    // ---------- TOP LIST ----------

async function loadTop() {
    try {
        const res = await fetch('/top');
        const list = await res.json(); // ожидается массив: [{id, name, elo}]
        renderTop(list);
    } catch (e) {
        console.error('Ошибка загрузки топа', e);
        topBody.innerHTML = `
            <tr>
                <td colspan="3" style="padding-top:8px;color:var(--text-muted);">
                    Не удалось загрузить рейтинг
                </td>
            </tr>`;
    }
}

function renderTop(list) {
    if (!Array.isArray(list) || list.length === 0) {
        topBody.innerHTML = `
            <tr>
                <td colspan="3" style="padding-top:8px;color:var(--text-muted);">
                    Пока никто не проголосовал
                </td>
            </tr>`;
        return;
    }

    topBody.innerHTML = '';

    list.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.className = 'top-row';

        // Ранг
        const rankTd = document.createElement('td');
        const badge = document.createElement('div');
        badge.className = 'badge-rank';

        if (index === 0) badge.classList.add('top1');
        if (index === 1) badge.classList.add('top2');
        if (index === 2) badge.classList.add('top3');

        badge.textContent = index + 1;
        rankTd.appendChild(badge);

        // Имя
        const nameTd = document.createElement('td');
        nameTd.textContent = item.name || 'Без имени';

        // Elo
        const eloTd = document.createElement('td');
        eloTd.style.textAlign = 'right';
        eloTd.textContent = item.elo;

        // Добавляем в строку
        tr.appendChild(rankTd);
        tr.appendChild(nameTd);
        tr.appendChild(eloTd);

        topBody.appendChild(tr);
    });
}

    refreshTopBtn.addEventListener('click', () => {
        refreshIcon.classList.add('top-refresh-spin');
        setTimeout(() => refreshIcon.classList.remove('top-refresh-spin'), 600);
        loadTop();
    });

    // первая загрузка
    loadPair();
    loadTop();
</script>
</body>
</html>